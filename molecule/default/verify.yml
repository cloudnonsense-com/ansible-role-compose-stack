---

- name: Verify
  hosts: all
  gather_facts: False
  roles:

  tasks:
    # Nginx-demo tests
    - name: Check nginx HTTP response
      ansible.builtin.uri:
        url: "http://host.docker.internal:37080"
        return_content: true
      register: nginx_response

    - name: Debug nginx response
      ansible.builtin.debug:
        var: nginx_response.content

    - name: Verify nginx status code
      ansible.builtin.assert:
        that:
          - nginx_response.status == 200
        fail_msg: "Nginx did not return HTTP 200 OK"
        success_msg: "Nginx returned HTTP 200 OK"

    - name: Verify nginx content
      ansible.builtin.assert:
        that:
          # - '"ansible role" in nginx_response.content'
          - nginx_response.content is search('deployed by the.*compose-stack.*ansible role')
        fail_msg: "Nginx content verification failed! Expected string not found."
        success_msg: "Nginx is serving the expected content."

    # Grafana tests
    - name: Check Grafana HTTP response
      ansible.builtin.uri:
        url: "http://host.docker.internal:37005"
        status_code: [200, 302]  # Grafana may redirect to login
      register: grafana_response

    - name: Verify Grafana is responding
      ansible.builtin.assert:
        that:
          - grafana_response.status in [200, 302]
        fail_msg: "Grafana did not return expected status"
        success_msg: "Grafana is responding"

    # InfluxDB tests
    - name: Check InfluxDB HTTP response
      ansible.builtin.uri:
        url: "http://host.docker.internal:8086/health"
        status_code: [200]
      register: influxdb_response

    - name: Verify InfluxDB is responding
      ansible.builtin.assert:
        that:
          - influxdb_response.status == 200
        fail_msg: "InfluxDB did not return HTTP 200"
        success_msg: "InfluxDB is responding"

    # Docker network tests
    - name: Check nginx-demo network exists
      ansible.builtin.command: docker network inspect nginx-demo
      register: nginx_network
      changed_when: false

    - name: Verify nginx-demo network exists
      ansible.builtin.assert:
        that:
          - nginx_network.rc == 0
        fail_msg: "nginx-demo network does not exist"
        success_msg: "nginx-demo network exists"

    - name: Check grafana network exists
      ansible.builtin.command: docker network inspect grafana
      register: grafana_network
      changed_when: false

    - name: Verify grafana network exists
      ansible.builtin.assert:
        that:
          - grafana_network.rc == 0
        fail_msg: "grafana network does not exist"
        success_msg: "grafana network exists"

    # Docker compose stack tests
    - name: Check nginx-demo compose stack status
      ansible.builtin.command: docker compose -f /opt/apps/nginx-demo/compose.yml ps
      register: nginx_stack
      changed_when: false

    - name: Verify nginx-demo stack is running
      ansible.builtin.assert:
        that:
          - "'nginx-demo' in nginx_stack.stdout"
        fail_msg: "nginx-demo stack is not running properly"
        success_msg: "nginx-demo stack is running"

    - name: Check grafana compose stack status
      ansible.builtin.command: docker compose -f /opt/apps/grafana/compose.yml ps
      register: grafana_stack
      changed_when: false

    - name: Verify grafana stack is running
      ansible.builtin.assert:
        that:
          - "'grafana' in grafana_stack.stdout"
          - "'influxdb' in grafana_stack.stdout"
        fail_msg: "grafana stack is not running properly"
        success_msg: "grafana stack is running"

...