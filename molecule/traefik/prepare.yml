---
- name: Prepare
  hosts: all
  gather_facts: True
  tasks:
    - name: Create Docker networks for traefik stack
      community.docker.docker_network:
        name: "{{ item }}"
        driver: bridge
        state: present
      loop:
        - traefik-dev

    - name: Set domain variable if not defined
      ansible.builtin.set_fact:
        test_domain: "{{ compose_stack_domain | default('example.lan') }}"

    - name: Generate self-signed wildcard certificate for testing
      ansible.builtin.command:
        cmd: >
          openssl req -x509 -nodes -days 365 -newkey rsa:2048
          -keyout /tmp/traefik-test.key
          -out /tmp/traefik-test.crt
          -subj "/C=US/ST=Test/L=Test/O=Test/CN=*.{{ test_domain }}"
          -addext "subjectAltName=DNS:*.{{ test_domain }},DNS:{{ test_domain }}"
        creates: /tmp/traefik-test.crt

    - name: Verify certificate files were created
      ansible.builtin.stat:
        path: "{{ item }}"
      register: cert_files
      loop:
        - /tmp/traefik-test.crt
        - /tmp/traefik-test.key

    - name: Display certificate file status
      ansible.builtin.debug:
        msg: "Certificate files created successfully"
      when: cert_files.results | selectattr('stat.exists') | list | length == 2
...
