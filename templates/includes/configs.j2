{# includes/configs.j2 #}
{#
  IMPORTANT: Dollar Sign Escaping for Docker Compose
  ---------------------------------------------------
  Docker Compose interprets $VAR as variable substitution. To embed literal dollar
  signs in inline configs, they must be escaped as $$:
    - ${FOO} becomes $${FOO}
    - Literal $$ becomes $$$$ (rare edge case)

  Example: "id = ${USER_ID}" â†’ "id = $${USER_ID}"

  The replace('$', '$$') filter auto-escapes both .j2 templates and static files.
#}
{% set all_configs = services | selectattr('configs', 'defined') | map(attribute='configs') | flatten | list %}
{% if all_configs | length > 0 %}
configs:
{% for config in all_configs %}
  "{{ config.source }}":
    content: |
{% set template_path = role_path ~ '/templates/' ~ stack.type ~ '/' ~ config.source ~ '.j2' %}
{% set raw_path = role_path ~ '/templates/' ~ stack.type ~ '/' ~ config.source %}
{% if template_path is file %}
      {{ lookup('template', template_path) | replace('$', '$$') | indent(6) }}
{% else %}
      {{ lookup('file', raw_path) | replace('$', '$$') | indent(6) }}
{% endif %}
{% endfor %}
{% endif %}
{# end #}