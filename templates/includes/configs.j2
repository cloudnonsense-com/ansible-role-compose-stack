{# includes/configs.j2 #}
{#
  IMPORTANT: Dollar Sign Escaping for Docker Compose
  ---------------------------------------------------
  Docker Compose interprets $VAR as variable substitution. To embed literal dollar
  signs in inline configs, they must be escaped as $$:
    - ${FOO} becomes $${FOO}
    - Literal $$ becomes $$$$ (rare edge case)

  Example: "id = ${USER_ID}" â†’ "id = $${USER_ID}"

  The replace('$', '$$') filter auto-escapes both .j2 templates and static files.

  Config File Handling:
  - Files ending in .j2 are processed as Jinja2 templates
  - Other files are copied as-is
  - The .j2 suffix is stripped from the Docker config name
#}
{% set all_configs = services | selectattr('configs', 'defined') | map(attribute='configs') | flatten | list %}
{% if all_configs | length > 0 %}
configs:
{% for config in all_configs %}
  "{{ config.source | regex_replace('\\.j2$', '') }}":
    content: |
{% set file_path = role_path ~ '/templates/' ~ stack.type ~ '/' ~ config.source %}
{% if config.source.endswith('.j2') %}
      {{ lookup('template', file_path) | replace('$', '$$') | indent(6) }}
{% else %}
      {{ lookup('file', file_path) | replace('$', '$$') | indent(6) }}
{% endif %}
{% endfor %}
{% endif %}
{# end #}